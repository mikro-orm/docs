(window.webpackJsonp=window.webpackJsonp||[]).push([[29],{183:function(e,n,t){"use strict";t.r(n),t.d(n,"frontMatter",(function(){return r})),t.d(n,"rightToc",(function(){return o})),t.d(n,"default",(function(){return s}));t(59),t(32),t(23),t(24),t(60),t(0);var a=t(233);function i(){return(i=Object.assign||function(e){for(var n=1;n<arguments.length;n++){var t=arguments[n];for(var a in t)Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a])}return e}).apply(this,arguments)}var r={title:"Migrations"},o=[{value:"Migration class",id:"migration-class",children:[]},{value:"Configuration",id:"configuration",children:[]},{value:"Using via CLI",id:"using-via-cli",children:[]},{value:"Using the Migrator programmatically",id:"using-the-migrator-programmatically",children:[]},{value:"Limitations",id:"limitations",children:[{value:"MySQL",id:"mysql",children:[]}]}],l={rightToc:o},c="wrapper";function s(e){var n=e.components,t=function(e,n){if(null==e)return{};var t,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)t=r[a],n.indexOf(t)>=0||(i[t]=e[t]);return i}(e,["components"]);return Object(a.b)(c,i({},l,t,{components:n,mdxType:"MDXLayout"}),Object(a.b)("p",null,"MikroORM has integrated support for migrations via ",Object(a.b)("a",i({parentName:"p"},{href:"https://github.com/sequelize/umzug"}),"umzug"),".\nIt allows you to generate migrations with current schema difference."),Object(a.b)("p",null,"By default, ech migration will be all executed inside a transaction, and all of them will\nbe wrapped in one master transaction, so if one of them fails, everything will be rolled back. "),Object(a.b)("h2",{id:"migration-class"},"Migration class"),Object(a.b)("p",null,"Migrations are classes that extend Migration abstract class:"),Object(a.b)("pre",null,Object(a.b)("code",i({parentName:"pre"},{className:"language-typescript"}),"export class Migration20191019195930 extends Migration {\n\n  async up(): Promise<void> {\n    this.addSql('select 1 + 1');\n  }\n\n}\n")),Object(a.b)("p",null,"To support undoing those changed, you can implement ",Object(a.b)("inlineCode",{parentName:"p"},"down")," method, which by default throws an error. "),Object(a.b)("p",null,"Transactions are by default wrapped in a transactions. You can override this behaviour on\nper transaction basis by implementing ",Object(a.b)("inlineCode",{parentName:"p"},"isTransactional(): boolean")," method."),Object(a.b)("p",null,Object(a.b)("inlineCode",{parentName:"p"},"Configuration")," object and driver instance are available in the ",Object(a.b)("inlineCode",{parentName:"p"},"Migration")," class context."),Object(a.b)("h2",{id:"configuration"},"Configuration"),Object(a.b)("pre",null,Object(a.b)("code",i({parentName:"pre"},{className:"language-typescript"}),"await MikroORM.init({\n  // default values:\n  migrations: {\n    tableName: 'mikro_orm_migrations', // name of database table with log of executed transactions\n    path: './migrations', // path to the folder with migrations\n    transactional: true, // wrap each migration in a transaction\n    disableForeignKeys: true, // wrap statements with `set foreign_key_checks = 0` or equivalent\n    allOrNothing: true, // wrap all migrations in master transaction\n  },\n})\n")),Object(a.b)("h2",{id:"using-via-cli"},"Using via CLI"),Object(a.b)("p",null,"You can use it via CLI: "),Object(a.b)("pre",null,Object(a.b)("code",i({parentName:"pre"},{className:"language-sh"}),"npx mikro-orm migration:create   # Create new migration with current schema diff\nnpx mikro-orm migration:up       # Migrate up to the latest version\nnpx mikro-orm migration:down     # Migrate one step down\nnpx mikro-orm migration:list     # List all executed migrations\nnpx mikro-orm migration:pending  # List all pending migrations\n")),Object(a.b)("p",null,"For ",Object(a.b)("inlineCode",{parentName:"p"},"migration:up")," and ",Object(a.b)("inlineCode",{parentName:"p"},"migration:down")," commands you can specify ",Object(a.b)("inlineCode",{parentName:"p"},"--from")," (",Object(a.b)("inlineCode",{parentName:"p"},"-f"),"), ",Object(a.b)("inlineCode",{parentName:"p"},"--to")," (",Object(a.b)("inlineCode",{parentName:"p"},"-t"),")\nand ",Object(a.b)("inlineCode",{parentName:"p"},"--only")," (",Object(a.b)("inlineCode",{parentName:"p"},"-o"),") options to run only a subset of migrations:"),Object(a.b)("pre",null,Object(a.b)("code",i({parentName:"pre"},{className:"language-sh"}),"npx mikro-orm migration:up --from 2019101911 --to 2019102117  # the same as above\nnpx mikro-orm migration:up --only 2019101923                  # apply a single migration\nnpx mikro-orm migration:down --to 0                           # migratee down all migrations\n")),Object(a.b)("blockquote",null,Object(a.b)("p",{parentName:"blockquote"},"To run TS migration files, you will need to ",Object(a.b)("a",i({parentName:"p"},{href:"/docs/v3-new/docs/installation"}),"enable ",Object(a.b)("inlineCode",{parentName:"a"},"useTsNode")," flag"),"\nin your ",Object(a.b)("inlineCode",{parentName:"p"},"package.json"),".")),Object(a.b)("h2",{id:"using-the-migrator-programmatically"},"Using the Migrator programmatically"),Object(a.b)("p",null,"Or you can create simple script where you initialize MikroORM like this:"),Object(a.b)("p",null,Object(a.b)("strong",{parentName:"p"},Object(a.b)("inlineCode",{parentName:"strong"},"./migrate.ts"))),Object(a.b)("pre",null,Object(a.b)("code",i({parentName:"pre"},{className:"language-typescript"}),"import { MikroORM } from 'mikro-orm';\n\n(async () => {\n  const orm = await MikroORM.init({\n    dbName: 'your-db-name',\n    // ...\n  });\n\n  const migrator = orm.getMigrator();\n  await migrator.createMigration(); // creates file Migration20191019195930.ts\n  await migrator.up(); // runs migrations up to the latest\n  await migrator.up('up-to-name'); // runs migrations up to given version\n  await migrator.down('down-to-name'); // runs migrations down to given version\n  await migrator.down(); // migrates one step down\n  await migrator.down({ to: 0 }); // migrates down to the first version\n\n  await orm.close(true);\n})();\n")),Object(a.b)("p",null,"Then run this script via ",Object(a.b)("inlineCode",{parentName:"p"},"ts-node")," (or compile it to plain JS and use ",Object(a.b)("inlineCode",{parentName:"p"},"node"),"):"),Object(a.b)("pre",null,Object(a.b)("code",i({parentName:"pre"},{className:"language-sh"}),"$ ts-node migrate\n")),Object(a.b)("h2",{id:"limitations"},"Limitations"),Object(a.b)("h3",{id:"mysql"},"MySQL"),Object(a.b)("p",null,"There is no way to rollback DDL changes in MySQL, implicit commit is forced for those\nqueries automatically, so transactions are not working as expected. "),Object(a.b)("ul",null,Object(a.b)("li",{parentName:"ul"},Object(a.b)("a",i({parentName:"li"},{href:"https://github.com/mikro-orm/mikro-orm/issues/217"}),"https://github.com/mikro-orm/mikro-orm/issues/217")),Object(a.b)("li",{parentName:"ul"},Object(a.b)("a",i({parentName:"li"},{href:"https://dev.mysql.com/doc/refman/5.7/en/implicit-commit.html"}),"https://dev.mysql.com/doc/refman/5.7/en/implicit-commit.html"))))}s.isMDXComponent=!0},233:function(e,n,t){"use strict";t.d(n,"a",(function(){return l})),t.d(n,"b",(function(){return p}));var a=t(0),i=t.n(a),r=i.a.createContext({}),o=function(e){var n=i.a.useContext(r),t=n;return e&&(t="function"==typeof e?e(n):Object.assign({},n,e)),t},l=function(e){var n=o(e.components);return i.a.createElement(r.Provider,{value:n},e.children)};var c="mdxType",s={inlineCode:"code",wrapper:function(e){var n=e.children;return i.a.createElement(i.a.Fragment,{},n)}},m=Object(a.forwardRef)((function(e,n){var t=e.components,a=e.mdxType,r=e.originalType,l=e.parentName,c=function(e,n){var t={};for(var a in e)Object.prototype.hasOwnProperty.call(e,a)&&-1===n.indexOf(a)&&(t[a]=e[a]);return t}(e,["components","mdxType","originalType","parentName"]),m=o(t),p=a,b=m[l+"."+p]||m[p]||s[p]||r;return t?i.a.createElement(b,Object.assign({},{ref:n},c,{components:t})):i.a.createElement(b,Object.assign({},{ref:n},c))}));function p(e,n){var t=arguments,a=n&&n.mdxType;if("string"==typeof e||a){var r=t.length,o=new Array(r);o[0]=m;var l={};for(var s in n)hasOwnProperty.call(n,s)&&(l[s]=n[s]);l.originalType=e,l[c]="string"==typeof e?e:a,o[1]=l;for(var p=2;p<r;p++)o[p]=t[p];return i.a.createElement.apply(null,o)}return i.a.createElement.apply(null,t)}m.displayName="MDXCreateElement"}}]);
